{{- $policyName := "dont-automount-service-account-token" -}}

apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: {{ $policyName }}
spec:
  validationFailureAction: enforce
  rules:
  - name: {{ $policyName }}
    match:
      any:
        - resources:
            kinds:
            - Pod
    validate:
      message: |
        `automountServiceAccountToken` should be disabled unless the pod requires access to the kubernetes API
      pattern:
        metadata:
          <(annotations):
            "X(kyverno.haff.xyz/ignore-{{ $policyName }})": "?*"
        spec:
          automountServiceAccountToken: false
